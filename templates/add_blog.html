<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title></title>
		<link rel="stylesheet" href="../static/css/addBlog.css?rnd=2" />
		<link rel="stylesheet" href="../static/plugins/editorPlugin/css/editormd.css" />
		
		<script src="../static/js/jquery.js"></script>
		<script src="../static/plugins/editorPlugin/editormd.js"></script>

		<script type="text/javascript">
            $(function() {
                editormd("test-editormd", {
                    width:"70%",
                    height:1000,
                    //lib目录的路径
                    path:"../static/plugins/editorPlugin/lib/",
                    saveHTMLToTextarea:true,
                    /*
                     图片上传

                         返回值（上传后的返回值）：
                                {	success: 0（上传失败） | 1（上传成功）,
                                    message: "成功或失败的提示信息",
                                    url: （图片地址--上传成功时才返回）
                                }
                    */
                    imageUpload:true,
                    imageFormats:["jpg", "jpeg", "gif", "png", "bmp", "webp"],
                    imageUploadURL:"../static/uploadfiles/articleImg",
                });
            });

            function addItem(obj, flag){
                //flag = 1：添加分类     flag = 2：添加标签
                var cl = flag == 2 ? '.articletag' : '.classify';

                var inputDiv = '<div class="textInputDiv" ondblclick="editClassfyFunc(this)">' +
                                    '<input type="text" id="editInput" class="editInput" disabled="true" onblur="EditInputOnblurFunc(this,' + flag + ')"/>' +
                                '</div>';

                var str = '<div class="itemDiv" id="itemDiv"> ' +
                                '<div class="checkboxDiv">' +
                                    '<input type="checkbox" value="aaa" class="checkbox_classfy" />' +
                                '</div>'+ inputDiv +'' +
                                '<div class="editClassfyDiv" id="editClassfyDiv">' +
                                '</div>' +
                         '</div>';
                // 查找classify 下的 selectDiv
                var selectDiv = $(obj).parent(cl).find('.selectDiv');
                var editInput = $(obj).parent(cl).find('.selectDiv').children("div:last-child").find('.editInput');
                // 向 selectDiv 下添加 itemDiv
                $(selectDiv).append(str);
                //获取 selectDiv 中最后一个 itemDiv
                var lastselectDiv = $(selectDiv).children("div:last-child");
                //设置最后一个 textInputDiv 中的input 处于编辑状态
                editClassfyFunc( $(lastselectDiv).find('.textInputDiv'));
            }

			function editClassfyFunc(obj) {
                // 获取当前时间对象的 class = 'itemDiv' 的父元素
                var pel = $(obj).parent('.itemDiv');
				var el = $(pel).find(".editInput");

				$(el).attr('disabled', false);
				$(el).focus();
				{#$(pel).find(".editClassfyDiv").css('display', 'block');#}
			}
			
			function EditInputOnblurFunc(obj, flag){
                var itemDivEl = $(obj).parent().parent();
                var inputVal = $(obj).val();
                var cl = '.classify';
                var tipS = '分类已存在';
                if(flag == 2){
                    cl = '.articletag';
                    tipS = '标签已存在';
                }
                //如果当前输入框对象的 value 值是空，则删除分类/标签数据
                if(!inputVal){
                    //获取分类/标签ID
                    var index_db = $(obj).attr('index_db');
                    //删除分类/标签
                    delClassfyTagInputVal(index_db, flag, obj);
                    // 删除当前元素以及所有子元素
                    $(itemDivEl).remove();
                    return;
                }

                {#console.log($(itemDivEl).index());#}
                //如果当前要保存的名称已存在则返回
                var hasSameName = false;
                $(cl).find('.editInput').each(function(index, item){
                    //如果当前事件对象的索引值等于循环中的index索引值，说明是当前修改的对象，则不进行值比较
                         if(index != $(itemDivEl).index()){
                             if($(item).val().toLowerCase() == inputVal.toLowerCase()){
                                 showTipSpan(flag, tipS,  'block');
                                 hasSameName = true;
                                 //结束循环
                                 return false;
                             }
                         }
                    })

                if(hasSameName){
                    $(obj).focus();
                    return;
                }
                //当前输入框对象的 value 值不是空，则保存数据
				$(obj).attr('disabled', true);
				{#console.log($(obj).attr('disabled'));#}
				{#$(itemDivEl).find(".editClassfyDiv").css('display', 'none');#}

                //如果当前保存的值 == 已有的原始值则返回
                if($(obj).attr('oldValue') == inputVal){
                    return;
                }

                console.log($(obj).attr('index_db'));
				saveClassfyTagInputVal(inputVal, flag, obj, $(obj).attr('index_db'));
			}

			function saveClassfyTagInputVal(text, flag, obj, id){
               var urlS = flag == 2 ? 'addArticleTag/': 'addArticleClassify/';

                $.ajax({
                    url: urlS,
                    data:id ? {value:text, id:id} : {value:text},
                    type:'GET',
                    dataType: 'json',
                    success:function(args) {
                        {#console.log(args);#}

                        if (args.action == 'addArticleClassify' || args.action == 'addArticleTag') {
                            //args.status = 1 保存成功  args.status = 0 失败
                            if (args.status < 1) {
                                showTipSpan(flag, args.msg, 'block');
                                // 保存失败，把输入框中的值恢复到原有值
                                $(obj).attr('oldValue', $(obj).attr('oldValue'));
                            } else {
                                showTipSpan(flag, '', 'none');
                                //设置当前添加修改对象的oldValue值
                                $(obj).attr('oldValue', text);

                                if (!$(obj).attr('index_db')) {
                                    $(obj).attr('index_db', args.id);
                                }
                            }
                        } else if (args.action == 'updateArticleClassify' || args.action == 'updateArticleTag') {
                             if(args.status < 1){
                                showTipSpan(flag, args.msg, 'block');
                                // 修改失败，把输入框中的值恢复到原有值
                                $(obj).attr('oldValue', $(obj).attr('oldValue'));
                             }else{
                                    showTipSpan(flag, '', 'none');
                                    //设置当前添加修改对象的oldValue值
                                    $(obj).attr('oldValue', text);

                                    if(!$(obj).attr('index_db')){
                                        $(obj).attr('index_db', args.id);
                                    }
                            }
                        }
                    }
                });
            }

            function delClassfyTagInputVal(id, flag, obj){
                var urlS = flag == 2 ? 'delArticleTag/': 'delArticleClassify/';
                $.ajax({
                    url: urlS,
                    data:{id:id},
                    type:'GET',
                    dataType: 'json',
                    success:function(args){
                        console.log(args);
                        if(args.status < 1){
                            showTipSpan(flag, args.msg, 'block');
                        }else{
                            showTipSpan(flag, '', 'none');
                        }
                    },
                });
            }
            function showTipSpan(flag, msg, show){
                var cl = flag == 2 ? '.articletag' : '.classify';
                var obj = $(cl).find('.tipSpan');
                $(obj).text(msg + " !");
                $(obj).css('display', show);
            }

			$(function() {
				$(".checkbox_classfy").change(function() {
					//					alert(this.checked);
					var positionx = 0;
					if(this.checked) {
						positionx = 48;
					}
					
					$(this).parent('.checkboxDiv').css({
						'background-image': 'url(static/images/blue.png)',
						'background-position-x': '-' + positionx + 'px',
						'background-position-y': '0px',
						'background-repeat': 'no-repeat'
					});
				});
			})
	
		</script>
		
	</head>
	<body>
		<div class="nav">
		
			<div class="article_active">
				<a href="#" class="save_article">保存</a>
				<a href="#" class="unsave_article">取消</a>
			</div>
			
			<img class="blogimg" src="../static/images/blog_icon.png"/>
			
			<div class="addblogDiv">
				<!--<img src="images/blog_add.png" />-->
				<a href="add_blog.html" target="_self"></a>
			</div>
			
			<ul>
				<li><a href="#">主页</a></li>
				<li><a href="#">文章</a></li>
				<li><a href="#">收藏</a></li>
				<li><a href="#">文件下载</a></li>
			</ul>
		</div>
		
		
		<div class="editormd" id="test-editormd">

			<textarea class="editormd-markdown-textarea" name="test-editormd-markdown-doc"></textarea>
				<!-- 第二个隐藏文本域，用来构造生成的HTML代码，方便表单POST提交，这里的name可以任意取，后台接受时以这个name键为准 -->
			<textarea class="editormd-html-textarea" name="text"></textarea>
		</div>
		
		<div class="classify_tag">
			<div class="classify">
			    <a href = "javascript:void(0);" onclick ="addItem(this, 1)"
				class="classify_addbtn"></a>
			    <h4>文章分类</h4>
                <p class="tipSpan">有未保存的分类 !</p>
			    <div class='selectDiv'>
                    {% for classify_item in classify_ret %}

                        <div class="itemDiv" id="itemDiv">
                            <div class="checkboxDiv">
                                <input type="checkbox" class="checkbox_classfy" />
                            </div>
                            <div class="textInputDiv" ondblclick="editClassfyFunc(this)">
                                <input type="text" value={{ classify_item.name }} id="editInput"
                                       oldValue={{ classify_item.name }} index_db={{ classify_item.id }}
                                class="editInput" disabled="true" onblur="EditInputOnblurFunc(this, 1)"/>
                            </div>
                            <div class="editClassfyDiv" id='editClassfyDiv' hidden>
                                <a href="#" class="cancle_saveBtn">取消</a>
                                <a href="#" class="saveClassfy_Btn"></a>
                            </div>
				        </div>
                    {% endfor %}
			</div>
		</div>
	
		    <div class="articletag">
			<a href = "javascript:void(0);" onclick ="addItem(this, 2)"
				class="articletag_addbtn"></a>
			<h4>文章标签</h4>
            <p class="tipSpan"> 有未保存的标签 !</p>
			<div class='selectDiv'>
                {% for tag_item in tag_ret %}
                    <div class="itemDiv" id="itemDiv">
                        <div class="checkboxDiv">
                            <input type="checkbox" class="checkbox_classfy" />
                        </div>
                        <div class="textInputDiv" ondblclick="editClassfyFunc(this)">
                            <input type="text" value={{ tag_item.name }}
                                    id="editInput" oldValue="{{ tag_item.name }}" index_db={{ tag_item.id }}
                            class="editInput" disabled="true" onblur="EditInputOnblurFunc(this, 2)"/>
                        </div>
                        <div class="editClassfyDiv" id='editClassfyDiv' hidden>
                            <a href="#" class="cancle_saveBtn">取消</a>
                            <a href="#" class="saveClassfy_Btn"></a>
                        </div>
				    </div>
                {% endfor %}
				</div>
			</div>
		</div>
	</body>
</html>
